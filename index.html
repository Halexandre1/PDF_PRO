<!DOCTYPE html>
appState.pdfDocLib.removePage(appState.draggedPageIndex);
let insertAt = targetIndex; if(appState.draggedPageIndex < targetIndex) insertAt = targetIndex - 1; // **ajuste de índice**
appState.pdfDocLib.insertPage(insertAt, moved);
await PDF.updateDocs(appState.pdfDocLib); UI.hideLoading();
}
},
onDragEnd(e){ e.target.closest('.pdf-page').classList.remove('dragging'); appState.draggedPageIndex=null; },
async onDropOnContainer(e){ DOM.pdfContainerWrapper.classList.remove('drop-zone-highlight'); const files = [...e.dataTransfer.files].filter(f=>f.type==='application/pdf'); if(!files.length) return UI.showModal('Por favor, solte apenas arquivos PDF válidos.'); await PDF.loadFiles(files); },
setup(){
DOM.importInput.addEventListener('change', (e)=>{ if(e.target.files.length) PDF.loadFiles([...e.target.files]); e.target.value=''; });
DOM.buttons.replace.addEventListener('click', PDF.replacePage);
DOM.buttons.rotateClockwise.addEventListener('click', ()=>PDF.rotatePages(90));
DOM.buttons.rotateCounterClockwise.addEventListener('click', ()=>PDF.rotatePages(-90));
DOM.buttons.remove.addEventListener('click', PDF.removePages);
DOM.buttons.split.addEventListener('click', PDF.split);
DOM.buttons.download.addEventListener('click', PDF.save);


// Modal: fechar com Esc/overlay
DOM.modal.container.addEventListener('click', (e)=>{ if(e.target===DOM.modal.container) UI.hideModal(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') UI.hideModal(); });
DOM.modal.closeButton.addEventListener('click', UI.hideModal);


// Tema
DOM.themeToggle.addEventListener('click', ()=>{ DOM.htmlEl.classList.toggle('dark'); const isDark=DOM.htmlEl.classList.contains('dark'); localStorage.setItem('theme', isDark?'dark':'light'); DOM.themeToggle.innerHTML=isDark?'☀️':'🌙'; });


// DnD
['dragenter','dragover','dragleave','drop'].forEach(evt=>document.body.addEventListener(evt, this.preventDefaults, false));
DOM.pdfContainerWrapper.addEventListener('dragenter', ()=>DOM.pdfContainerWrapper.classList.add('drop-zone-highlight'));
DOM.pdfContainerWrapper.addEventListener('dragleave', ()=>DOM.pdfContainerWrapper.classList.remove('drop-zone-highlight'));
DOM.pdfContainerWrapper.addEventListener('drop', this.onDropOnContainer);


// Logo
DOM.changeLogoBtn.addEventListener('click', ()=>DOM.logoInput.click());
DOM.clearLogoBtn.addEventListener('click', ()=>{ localStorage.removeItem('appLogoData'); DOM.logoImg.src='https://placehold.co/56x56/4f46e5/ffffff?text=LOGO'; DOM.favicon.href = DOM.logoImg.src; });
DOM.logoInput.addEventListener('change', async (e)=>{
const file = e.target.files?.[0]; if(!file) return; const dataUrl = await fileToDataURL(file);
DOM.logoImg.src = dataUrl; localStorage.setItem('appLogoData', dataUrl); DOM.favicon.href = dataUrl;
});
}
};


// Utils
function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
function restoreLogo(){ const saved = localStorage.getItem('appLogoData'); if(saved){ DOM.logoImg.src = saved; DOM.favicon.href = saved; } }


// Boot
document.addEventListener('DOMContentLoaded', ()=>{ UI.updateButtonStates(); UI.loadTheme(); UI.setSignature(); restoreLogo(); EventHandlers.setup(); });
</script>
</body>
</html>
